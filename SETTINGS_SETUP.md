# Настройка приложения Jira Estimate

## Обзор

В приложении Jira Estimate добавлено модальное окно настроек, которое позволяет пользователям настраивать подключения к Jira и AI сервисам. Все настройки сохраняются в базе данных с шифрованием токенов для обеспечения безопасности.

## Функциональность

### Модальное окно настроек
- Доступно через иконку настроек в шапке приложения
- Две секции: настройки Jira и настройки AI
- Возможность тестирования подключений
- Безопасное хранение токенов с шифрованием

### Настройки Jira
- **URL Jira**: Базовый URL вашего Jira (например, `https://your-domain.atlassian.net`)
- **Имя пользователя**: Имя пользователя в Jira
- **Email**: Email адрес, связанный с Jira аккаунтом
- **API Token**: Токен API для аутентификации

### Настройки AI
- **Хост AI сервиса**: URL AI сервиса (например, `https://api.openai.com`)
- **API Token**: Токен для доступа к AI сервису

## Безопасность

### Шифрование токенов
- Все токены (Jira API Token, AI Token) шифруются перед сохранением в базу данных
- Используется AES шифрование с ключом из переменных окружения
- Токены автоматически расшифровываются при получении из базы данных

### Переменные окружения
Добавьте в ваш `.env` файл:

```env
# Ключ шифрования (обязательно измените в продакшене!)
ENCRYPTION_KEY=your-super-secret-encryption-key
```

## API Endpoints

### GET /api/settings
Получение текущих настроек пользователя

**Ответ:**
```json
{
  "jira": {
    "baseUrl": "https://your-domain.atlassian.net",
    "username": "username",
    "email": "user@example.com",
    "apiToken": "encrypted_token"
  },
  "ai": {
    "host": "https://api.openai.com",
    "token": "encrypted_token"
  }
}
```

### PUT /api/settings
Обновление настроек пользователя

**Тело запроса:**
```json
{
  "jira": {
    "baseUrl": "https://new-domain.atlassian.net",
    "username": "new_username",
    "email": "new@example.com",
    "apiToken": "new_token"
  },
  "ai": {
    "host": "https://api.openai.com",
    "token": "new_ai_token"
  }
}
```

### POST /api/settings/test-jira
Тестирование подключения к Jira

**Тело запроса:**
```json
{
  "baseUrl": "https://your-domain.atlassian.net",
  "email": "user@example.com",
  "apiToken": "your_token"
}
```

**Ответ:**
```json
{
  "connected": true,
  "message": "Подключение к Jira успешно установлено"
}
```

### POST /api/settings/test-ai
Тестирование подключения к AI сервису

**Тело запроса:**
```json
{
  "host": "https://api.openai.com",
  "token": "your_ai_token"
}
```

**Ответ:**
```json
{
  "connected": true,
  "message": "Подключение к AI сервису успешно установлено"
}
```

## База данных

### Новые поля в таблице users
- `aiHost` (VARCHAR) - хост AI сервиса
- `aiToken` (VARCHAR) - зашифрованный токен AI сервиса

### Миграция
При первом запуске приложения новые поля будут автоматически добавлены в базу данных благодаря Sequelize.

## Использование

### Открытие настроек
1. Войдите в приложение
2. Нажмите на иконку настроек (⚙️) в правом верхнем углу
3. Откроется модальное окно с настройками

### Настройка Jira
1. Заполните поля в секции "Настройки Jira"
2. Нажмите "Тестировать подключение" для проверки
3. При успешном тестировании нажмите "Сохранить"

### Настройка AI
1. Заполните поля в секции "Настройки AI"
2. Нажмите "Тестировать подключение" для проверки
3. При успешном тестировании нажмите "Сохранить"

### Безопасность токенов
- Токены отображаются как скрытые поля (точки)
- Используйте кнопку с глазом для показа/скрытия токенов
- Все токены автоматически шифруются при сохранении

## Технические детали

### Компоненты
- `SettingsModal.tsx` - основной компонент модального окна
- `encryption.js` - утилиты для шифрования/расшифровки
- `settings.js` - API маршруты для работы с настройками

### Хуки Sequelize
- `beforeCreate` - шифрование токенов при создании пользователя
- `beforeUpdate` - шифрование токенов при обновлении
- `afterFind` - расшифровка токенов при получении из БД

### Зависимости
- `crypto-js` - для шифрования токенов
- `axios` - для тестирования подключений

## Устранение неполадок

### Ошибка "Не удалось подключиться к Jira"
1. Проверьте правильность URL Jira
2. Убедитесь, что email и API токен корректны
3. Проверьте доступность Jira сервера

### Ошибка "Не удалось подключиться к AI сервису"
1. Проверьте правильность хоста AI сервиса
2. Убедитесь, что API токен действителен
3. Проверьте доступность AI сервиса

### Ошибки шифрования
1. Убедитесь, что `ENCRYPTION_KEY` установлен в переменных окружения
2. Проверьте, что ключ не изменялся после создания пользователей
3. При изменении ключа потребуется миграция данных

## Безопасность в продакшене

1. **Обязательно измените `ENCRYPTION_KEY`** на уникальный ключ
2. Используйте HTTPS для всех API запросов
3. Регулярно обновляйте API токены
4. Ограничьте доступ к базе данных
5. Используйте сильные пароли для всех сервисов
